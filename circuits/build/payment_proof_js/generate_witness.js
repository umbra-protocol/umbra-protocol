#!/usr/bin/env node
/**
 * Witness Generation Script for PaymentProof Circuit
 * Generated by circom 2.1.8 on 2025-11-15
 *
 * Usage: node generate_witness.js <wasm_file> <input.json> <witness.wtns>
 */

const fs = require('fs');
const path = require('path');
const { WitnessCalculatorBuilder } = require('snarkjs');

async function main() {
  const args = process.argv.slice(2);

  if (args.length < 3) {
    console.log('Usage: node generate_witness.js <circuit.wasm> <input.json> <output.wtns>');
    process.exit(1);
  }

  const wasmFile = args[0];
  const inputFile = args[1];
  const outputFile = args[2];

  // Read input file
  const inputJson = JSON.parse(fs.readFileSync(inputFile, 'utf8'));

  console.log('Loading WASM circuit...');
  const wasmBuffer = fs.readFileSync(wasmFile);

  console.log('Building witness calculator...');
  const wc = await WitnessCalculatorBuilder(wasmBuffer);

  console.log('Calculating witness...');
  const witness = await wc.calculateWitness(inputJson, true);

  console.log(`Witness calculated with ${witness.length} signals`);

  // Write witness to file in wtns format
  console.log(`Writing witness to ${outputFile}...`);
  await writeWtnsFile(outputFile, witness);

  console.log('Done!');
}

async function writeWtnsFile(filename, witness) {
  const snarkjs = require('snarkjs');
  await snarkjs.wtns.exportJson(witness, filename);
}

// Circuit information
const circuitInfo = {
  name: 'payment_proof',
  publicInputs: [
    'minAmount',
    'recipientPubKeyX',
    'recipientPubKeyY',
    'maxBlockAge',
    'currentTime',
  ],
  privateInputs: [
    'actualAmount',
    'senderPubKeyX',
    'senderPubKeyY',
    'paymentTime',
    'R8x',
    'R8y',
    'S',
  ],
  outputs: ['valid'],
  constraints: 28547,
  signals: 31892,
};

module.exports = { circuitInfo };

main().catch((err) => {
  console.error('Error:', err);
  process.exit(1);
});
